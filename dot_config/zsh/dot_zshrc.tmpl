# =============================================================================
# ZSH Configuration (managed by chezmoi)
# =============================================================================

# -----------------------------------------------------------------------------
# PATH additions
# -----------------------------------------------------------------------------
export PATH="$HOME/.local/bin:$PATH"

{{- if .hasHomebrew }}
# -----------------------------------------------------------------------------
# Homebrew (must be first for PATH)
# -----------------------------------------------------------------------------
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- end }}

{{- if .hasMise }}
# -----------------------------------------------------------------------------
# mise (version manager for node, go, python, etc.)
# -----------------------------------------------------------------------------
if command -v mise &>/dev/null; then
    eval "$(mise activate zsh)"
fi
{{- end }}

# -----------------------------------------------------------------------------
# Prompt (Starship)
# -----------------------------------------------------------------------------
if command -v starship &>/dev/null; then
    eval "$(starship init zsh)"
fi

# -----------------------------------------------------------------------------
# Source modular configs (order matters!)
# -----------------------------------------------------------------------------
# 1. Completions first (sets up history, completion system, fzf, key bindings)
[[ -f "$ZDOTDIR/completions.zsh" ]] && source "$ZDOTDIR/completions.zsh"

# 2. Modern CLI tools (zoxide, eza, bat, atuin, direnv)
[[ -f "$ZDOTDIR/tools.zsh" ]] && source "$ZDOTDIR/tools.zsh"

# 3. Aliases
[[ -f "$ZDOTDIR/aliases.zsh" ]] && source "$ZDOTDIR/aliases.zsh"

# 4. Functions
[[ -f "$ZDOTDIR/functions.zsh" ]] && source "$ZDOTDIR/functions.zsh"

{{- if .hasHomebrew }}
# -----------------------------------------------------------------------------
# Zsh plugins (via Homebrew) - AFTER completions.zsh sets strategies
# -----------------------------------------------------------------------------
# Autosuggestions (shows inline suggestions from history)
if [[ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
    source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

# Fast syntax highlighting (better than zsh-syntax-highlighting - must be last!)
if [[ -f /opt/homebrew/opt/zsh-fast-syntax-highlighting/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh ]]; then
    source /opt/homebrew/opt/zsh-fast-syntax-highlighting/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh
fi
{{- else }}
# -----------------------------------------------------------------------------
# Zsh plugins (Linux locations)
# -----------------------------------------------------------------------------
# Try common Linux plugin locations
for dir in /usr/share /usr/local/share "$HOME/.local/share"; do
    if [[ -f "$dir/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
        source "$dir/zsh-autosuggestions/zsh-autosuggestions.zsh"
        break
    fi
done

for dir in /usr/share /usr/local/share "$HOME/.local/share"; do
    if [[ -f "$dir/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
        source "$dir/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
        break
    fi
done
{{- end }}

{{- if .has1Password }}
# -----------------------------------------------------------------------------
# 1Password SSH agent (for agent forwarding to work)
# -----------------------------------------------------------------------------
if [[ -S "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock" ]]; then
    export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
fi

# -----------------------------------------------------------------------------
# 1Password CLI plugin (if exists)
# -----------------------------------------------------------------------------
if [[ -f "$HOME/.config/op/plugins.sh" ]]; then
    source "$HOME/.config/op/plugins.sh"
fi
{{- end }}

# pnpm
export PNPM_HOME="{{ .chezmoi.homeDir }}/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
