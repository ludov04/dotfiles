#!/bin/bash
# =============================================================================
# Setup SSH config include
# Runs once after dotfiles are applied
# =============================================================================

mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"

SSH_INCLUDE="Include {{ .chezmoi.homeDir }}/.config/ssh/config"

if [[ ! -f "$HOME/.ssh/config" ]]; then
    # Create new config with include
    cat > "$HOME/.ssh/config" << EOF
# =============================================================================
# SSH Config
# =============================================================================
# Include shared settings from chezmoi-managed dotfiles
$SSH_INCLUDE

# -----------------------------------------------------------------------------
# Machine-specific hosts and auto-generated blocks below
# -----------------------------------------------------------------------------
EOF
    chmod 600 "$HOME/.ssh/config"
    echo "==> Created ~/.ssh/config with Include"
elif ! grep -q "Include.*\.config/ssh/config" "$HOME/.ssh/config"; then
    # Add include to existing config
    {
        echo "# Include shared settings from chezmoi-managed dotfiles"
        echo "$SSH_INCLUDE"
        echo ""
        cat "$HOME/.ssh/config"
    } > "$HOME/.ssh/config.tmp"
    mv "$HOME/.ssh/config.tmp" "$HOME/.ssh/config"
    chmod 600 "$HOME/.ssh/config"
    echo "==> Added Include to existing ~/.ssh/config"
else
    echo "==> ~/.ssh/config already includes dotfiles"
fi
