#!/bin/bash
# =============================================================================
# Chezmoi pre-install script
# Runs once before applying dotfiles
# =============================================================================
set -e

echo "==> Chezmoi: Running pre-install..."

# -----------------------------------------------------------------------------
# Create XDG directories
# -----------------------------------------------------------------------------
mkdir -p "$HOME/.config"
mkdir -p "$HOME/.local/share"
mkdir -p "$HOME/.local/state/zsh"
mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.cache/zsh"

{{- if .hasHomebrew }}
# -----------------------------------------------------------------------------
# macOS: Install Homebrew if not present
# -----------------------------------------------------------------------------
if ! command -v brew &>/dev/null; then
    echo "==> Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install from Brewfile
if [[ -f "{{ .chezmoi.sourceDir }}/Brewfile" ]]; then
    echo "==> Installing Homebrew packages..."
    brew bundle --file="{{ .chezmoi.sourceDir }}/Brewfile"
fi
{{- end }}

{{- if .isDevpod }}
# -----------------------------------------------------------------------------
# Devpod: Install minimal tools
# -----------------------------------------------------------------------------
echo "==> Devpod environment detected, installing minimal tools..."

if command -v apt-get &>/dev/null; then
    sudo apt-get update -qq
    sudo apt-get install -y --no-install-recommends \
        curl \
        git \
        zsh \
        fzf \
        ripgrep \
        jq

    # Install bat (Debian/Ubuntu names it batcat)
    if ! command -v bat &>/dev/null && ! command -v batcat &>/dev/null; then
        sudo apt-get install -y bat
        [[ -f /usr/bin/batcat ]] && sudo ln -sf /usr/bin/batcat /usr/local/bin/bat
    fi
fi

# Install starship
if ! command -v starship &>/dev/null; then
    echo "==> Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Install eza
if ! command -v eza &>/dev/null && command -v apt-get &>/dev/null; then
    echo "==> Installing eza..."
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | \
        sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg 2>/dev/null || true
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | \
        sudo tee /etc/apt/sources.list.d/gierens.list >/dev/null
    sudo apt-get update -qq && sudo apt-get install -y eza
fi

# Install zoxide
if ! command -v zoxide &>/dev/null; then
    echo "==> Installing zoxide..."
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
fi
{{- end }}

# -----------------------------------------------------------------------------
# Install tmux plugin manager
# -----------------------------------------------------------------------------
if [[ ! -d "$HOME/.tmux/plugins/tpm" ]]; then
    echo "==> Installing tmux plugin manager..."
    git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi

echo "==> Pre-install complete!"
